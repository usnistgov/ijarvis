# from core_main_app.utils.rendering import render
from django.shortcuts import render
from .forms import ContactForm
from django.http import HttpResponse
from jarvis.io.vasp.inputs import Poscar
#from jarvis.ai.descriptors.cfid import CFID
import numpy as np
import os
from jarvis.core.graphs import Graph
from alignn.models.alignn import ALIGNN,ALIGNNConfig
import torch
#import joblib, pickle
from numpy import linalg as LA
from jarvis.core.kpoints import Kpoints3D

device = "cpu"
#if torch.cuda.is_available():
#        device = torch.device("cuda")


base_path = os.path.join(os.path.dirname(__file__), "extras")

fen_path = os.path.join(base_path, "hmof_co2_absp_alignnn.pt")
#fen_path = os.path.join(base_path, "hmof_max_co2_adsp_alignn.pt")

form_file = ALIGNN(ALIGNNConfig(name="alignn", output_features=5))
form_file.load_state_dict(torch.load(fen_path, map_location=device)["model"])
form_file.to(device)
form_file.eval()



from django.utils.decorators import method_decorator
import core_main_app.utils.decorators as decorators
import core_explore_keyword_app.permissions.rights as rights
from django.urls import reverse_lazy, reverse

@decorators.permission_required(
    content_type=rights.EXPLORE_KEYWORD_CONTENT_TYPE,
    #content_type=rights.explore_keyword_content_type,
    permission=rights.EXPLORE_KEYWORD_ACCESS,
    #permission=rights.explore_keyword_access,
    #permission=None,
    login_url=reverse_lazy("core_main_app_login"),
    raise_exception=False,
)

def contact(request):
    form = ContactForm(
        {
            "body": "ZIF-8\n1.0\n-8.4955 8.4955 8.4955\n8.4955 -8.4955 8.4955\n8.4955 8.4955 -8.4955\nZn N H C\n6 24 96 48\ndirect\n0.75 0.25 0.5 \n0.25 0.75 0.5 \n0.5 0.75 0.25 \n0.5 0.25 0.75 \n0.25 0.5 0.75 \n0.75 0.5 0.25 \n0.6510999999999998 0.09250999999999998 0.3780499999999999 \n0.7144600000000001 0.27304999999999985 0.62195 \n0.2855399999999999 0.90749 0.5585899999999998 \n0.3489000000000002 0.7269500000000002 0.44141000000000025 \n0.37804999999999994 0.6510999999999998 0.09251000000000004 \n0.6219500000000001 0.7144600000000001 0.2730499999999999 \n0.5585899999999997 0.2855399999999999 0.9074899999999999 \n0.4414100000000002 0.3489000000000002 0.7269500000000001 \n0.09251000000000004 0.37804999999999994 0.6510999999999998 \n0.2730499999999999 0.6219500000000001 0.7144600000000001 \n0.9074899999999999 0.5585899999999997 0.2855399999999999 \n0.7269500000000001 0.4414100000000002 0.3489000000000002 \n0.09250999999999998 0.6510999999999998 0.3780499999999999 \n0.27304999999999985 0.7144600000000001 0.62195 \n0.90749 0.2855399999999999 0.5585899999999998 \n0.7269500000000002 0.3489000000000002 0.44141000000000025 \n0.6510999999999998 0.37804999999999994 0.09251000000000004 \n0.7144600000000001 0.6219500000000001 0.2730499999999999 \n0.2855399999999999 0.5585899999999997 0.9074899999999999 \n0.3489000000000002 0.4414100000000002 0.7269500000000001 \n0.37804999999999994 0.09251000000000004 0.6510999999999998 \n0.6219500000000001 0.2730499999999999 0.7144600000000001 \n0.5585899999999997 0.9074899999999999 0.2855399999999999 \n0.4414100000000002 0.7269500000000001 0.3489000000000002 \n0.5822999999999998 0.10110000000000008 0.23659999999999987 \n0.6540999999999998 0.03300000000000006 0.5385 \n0.7591999999999998 0.04219999999999982 0.5286 \n0.6563999999999997 0.9248999999999997 0.47629999999999983 \n0.8645000000000002 0.34570000000000006 0.7634000000000001 \n0.4945000000000001 0.11559999999999987 0.4615 \n0.5136000000000001 0.23059999999999992 0.4714000000000002 \n0.4485999999999999 0.18009999999999982 0.5237000000000002 \n0.13549999999999973 0.8988999999999999 0.48119999999999974 \n0.5054999999999998 0.967 0.6210999999999998 \n0.4864 0.9578000000000002 0.7169999999999999 \n0.5514000000000001 0.07510000000000028 0.7314999999999999 \n0.4177000000000001 0.6542999999999999 0.5188000000000001 \n0.3459000000000002 0.8844000000000001 0.37890000000000024 \n0.24080000000000024 0.7694000000000001 0.28300000000000003 \n0.34360000000000035 0.8199000000000002 0.26850000000000007 \n0.23659999999999975 0.5822999999999998 0.10110000000000002 \n0.5385 0.6540999999999999 0.03300000000000014 \n0.5285999999999997 0.7591999999999997 0.04219999999999979 \n0.47629999999999983 0.6563999999999997 0.9248999999999997 \n0.7634000000000001 0.8645000000000003 0.3457 \n0.4615000000000001 0.49450000000000016 0.11559999999999995 \n0.47140000000000015 0.5136 0.2305999999999999 \n0.5237000000000002 0.4485999999999999 0.18009999999999982 \n0.48119999999999985 0.1354999999999998 0.8989 \n0.6210999999999998 0.5054999999999998 0.967 \n0.717 0.48640000000000005 0.9578000000000002 \n0.7314999999999999 0.5514000000000001 0.07510000000000028 \n0.5188000000000001 0.41770000000000007 0.6543 \n0.37890000000000024 0.3459000000000002 0.8844000000000001 \n0.28300000000000014 0.2408000000000003 0.7694000000000001 \n0.26850000000000007 0.34360000000000035 0.8199000000000002 \n0.10110000000000002 0.23659999999999975 0.5822999999999998 \n0.03300000000000014 0.5385 0.6540999999999999 \n0.04219999999999979 0.5285999999999997 0.7591999999999997 \n0.9248999999999996 0.4762999999999998 0.6563999999999997 \n0.3457 0.7634000000000001 0.8645000000000003 \n0.11559999999999995 0.4615000000000001 0.49450000000000016 \n0.2305999999999999 0.47140000000000015 0.5136 \n0.18009999999999987 0.5237000000000003 0.4485999999999999 \n0.8989 0.48119999999999985 0.1354999999999998 \n0.967 0.6210999999999998 0.5054999999999998 \n0.9578000000000002 0.717 0.48640000000000005 \n0.07510000000000033 0.7315 0.5514000000000001 \n0.6543 0.5188000000000001 0.41770000000000007 \n0.8844000000000001 0.37890000000000024 0.3459000000000002 \n0.7694000000000001 0.28300000000000014 0.2408000000000003 \n0.8199000000000001 0.2685 0.34360000000000035 \n0.10110000000000008 0.5822999999999998 0.23659999999999987 \n0.03300000000000006 0.6540999999999998 0.5385 \n0.04219999999999982 0.7591999999999998 0.5286 \n0.9248999999999997 0.6563999999999997 0.47629999999999983 \n0.34570000000000006 0.8645000000000002 0.7634000000000001 \n0.11559999999999987 0.4945000000000001 0.4615 \n0.23059999999999992 0.5136000000000001 0.4714000000000002 \n0.18009999999999982 0.4485999999999999 0.5237000000000002 \n0.8988999999999999 0.13549999999999973 0.48119999999999974 \n0.967 0.5054999999999998 0.6210999999999998 \n0.9578000000000002 0.4864 0.7169999999999999 \n0.07510000000000028 0.5514000000000001 0.7314999999999999 \n0.6542999999999999 0.4177000000000001 0.5188000000000001 \n0.8844000000000001 0.3459000000000002 0.37890000000000024 \n0.7694000000000001 0.24080000000000024 0.28300000000000003 \n0.8199000000000002 0.34360000000000035 0.26850000000000007 \n0.5822999999999998 0.23659999999999975 0.10110000000000002 \n0.6540999999999999 0.5385 0.03300000000000014 \n0.7591999999999997 0.5285999999999997 0.04219999999999979 \n0.6563999999999997 0.47629999999999983 0.9248999999999997 \n0.8645000000000003 0.7634000000000001 0.3457 \n0.49450000000000016 0.4615000000000001 0.11559999999999995 \n0.5136 0.47140000000000015 0.2305999999999999 \n0.4485999999999999 0.5237000000000002 0.18009999999999982 \n0.1354999999999998 0.48119999999999985 0.8989 \n0.5054999999999998 0.6210999999999998 0.967 \n0.48640000000000005 0.717 0.9578000000000002 \n0.5514000000000001 0.7314999999999999 0.07510000000000028 \n0.41770000000000007 0.5188000000000001 0.6543 \n0.3459000000000002 0.37890000000000024 0.8844000000000001 \n0.2408000000000003 0.28300000000000014 0.7694000000000001 \n0.34360000000000035 0.26850000000000007 0.8199000000000002 \n0.23659999999999975 0.10110000000000002 0.5822999999999998 \n0.5385 0.03300000000000014 0.6540999999999999 \n0.5285999999999997 0.04219999999999979 0.7591999999999997 \n0.4762999999999998 0.9248999999999996 0.6563999999999997 \n0.7634000000000001 0.3457 0.8645000000000003 \n0.4615000000000001 0.11559999999999995 0.49450000000000016 \n0.47140000000000015 0.2305999999999999 0.5136 \n0.5237000000000003 0.18009999999999987 0.4485999999999999 \n0.48119999999999985 0.8989 0.1354999999999998 \n0.6210999999999998 0.967 0.5054999999999998 \n0.717 0.9578000000000002 0.48640000000000005 \n0.7315 0.07510000000000033 0.5514000000000001 \n0.5188000000000001 0.6543 0.41770000000000007 \n0.37890000000000024 0.8844000000000001 0.3459000000000002 \n0.28300000000000014 0.7694000000000001 0.2408000000000003 \n0.2685 0.8199000000000001 0.34360000000000035 \n0.5866399999999998 0.05601000000000003 0.26764999999999994 \n0.7883600000000002 0.31898999999999983 0.7323500000000001 \n0.21163999999999988 0.94399 0.5306299999999997 \n0.4133600000000002 0.6810100000000001 0.4693700000000003 \n0.26764999999999994 0.5866399999999998 0.056010000000000115 \n0.7323500000000001 0.7883600000000002 0.3189899999999999 \n0.5306299999999997 0.21163999999999994 0.94399 \n0.4693700000000003 0.4133600000000003 0.6810100000000001 \n0.056010000000000115 0.26764999999999994 0.5866399999999998 \n0.3189899999999999 0.7323500000000001 0.7883600000000002 \n0.94399 0.5306299999999997 0.21163999999999994 \n0.6810100000000001 0.4693700000000003 0.4133600000000003 \n0.05601000000000003 0.5866399999999998 0.26764999999999994 \n0.31898999999999983 0.7883600000000002 0.7323500000000001 \n0.94399 0.21163999999999988 0.5306299999999997 \n0.6810100000000001 0.4133600000000002 0.4693700000000003 \n0.5866399999999998 0.26764999999999994 0.056010000000000115 \n0.7883600000000002 0.7323500000000001 0.3189899999999999 \n0.21163999999999994 0.5306299999999997 0.94399 \n0.4133600000000003 0.4693700000000003 0.6810100000000001 \n0.26764999999999994 0.056010000000000115 0.5866399999999998 \n0.7323500000000001 0.3189899999999999 0.7883600000000002 \n0.5306299999999997 0.94399 0.21163999999999994 \n0.4693700000000003 0.6810100000000001 0.4133600000000003 \n0.6308499999999998 0.0 0.38495 \n0.6793999999999998 -2.7755575615628914e-17 0.49160000000000004 \n0.61505 0.24589999999999979 0.61505 \n0.5084 0.18779999999999977 0.5084 \n0.38494999999999996 0.0 0.6308499999999997 \n0.49160000000000004 2.7755575615628914e-17 0.6793999999999998 \n0.3691500000000002 0.7541000000000002 0.3691500000000002 \n0.3206000000000002 0.8122000000000003 0.3206000000000002 \n0.38494999999999996 0.6308499999999997 0.0 \n0.49160000000000004 0.6793999999999998 0.0 \n0.61505 0.61505 0.24589999999999979 \n0.5084 0.5084 0.18779999999999977 \n0.6308499999999997 0.38494999999999996 0.0 \n0.6793999999999998 0.49160000000000004 2.7755575615628914e-17 \n0.36915000000000026 0.36915000000000026 0.7541000000000002 \n0.3206000000000002 0.3206000000000002 0.8122000000000003 \n0.0 0.38494999999999996 0.6308499999999997 \n2.7755575615628914e-17 0.49160000000000004 0.6793999999999998 \n0.24589999999999979 0.61505 0.61505 \n0.18779999999999977 0.5084 0.5084 \n0.0 0.6308499999999998 0.38495 \n-2.7755575615628914e-17 0.6793999999999998 0.49160000000000004 \n0.7541000000000002 0.3691500000000002 0.3691500000000002 \n0.8122000000000003 0.3206000000000002 0.3206000000000002 \n"
        }
    )
    result = ""
    if request.method == "POST":
        try:
            form = ContactForm(request.POST)
            if form.is_valid():
                body = form.cleaned_data["body"]
                mat = Poscar.from_string(body).atoms

                if len(body) < 20000:
                    g, lg = Graph.atom_dgl_multigraph(mat)
                    f_en=form_file([g.to(device), lg.to(device)]).detach().cpu().numpy().flatten().tolist()
                    f_en = np.array(f_en,dtype='float') #round(float(f_en), 3)
                    print('f_en',f_en)
                    result = (
                        "CO2 adsorption:\n"+"Pressure(bar), Adsorption(mol/kg)\n"
                        + str(0.01)+","+str(round(f_en[0],5))+"\n"
                        + str(0.05)+","+str(round(f_en[1],5))+"\n"
                        + str(0.1)+","+str(round(f_en[2],5))+"\n"
                        + str(0.5)+","+str(round(f_en[3],5))+"\n"
                        + str(2.5)+","+str(round(f_en[4],5))+"\n"
                        + "\n\n input"
                        + str("\n" + body)
                        + "\n"
                    )

        except Exception as exp:
            print("Cannot run JARVIS-ALIGNN.",exp)
            pass
    return render(
        request, "jdac/dac.html", {"form": form, "result": result}
    )
    # return render(request, "jarvisml/jarvisml.html", context={"form": form, "result": result})
